/** \file
 * This file contains the implementation of an object which is used to
 * manipulate the Software Guard Extensions (SGX) signature structure
 * SIGSTRUCT.
 *
 * The SIGSTRUCT is a data structure which implements the information
 * used to verify the ownership, integrity and measurement status of
 * an enclave.  This structure is a component of the SGX metadata
 * which is handled by the SGXmetadata object.
 */

/**************************************************************************
 * (C)Copyright 2016, IDfusion, LLC. All rights reserved.
 *
 * Please refer to the file named COPYING in the top of the source tree
 * for licensing information.
 **************************************************************************/

/* Include files. */
#include <stdint.h>
#include <stdlib.h>
#include <stdbool.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#include <libelf.h>

#include <Origin.h>
#include <HurdLib.h>
#include <Buffer.h>
#include <String.h>
#include <File.h>

#include "NAAAIM.h"
#include "SGX.h"
#include "SGXsigstruct.h"


/* Object state extraction macro. */
#define STATE(var) CO(SGXsigstruct_State, var) = this->state

/* Verify library/object header file inclusions. */
#if !defined(NAAAIM_LIBID)
#error Library identifier not defined.
#endif

#if !defined(NAAAIM_SGXsigstruct_OBJID)
#error Object identifier not defined.
#endif


/**
 * This character array holds the binary representation of the most
 * recently received Intel launch enclave.  It avoids the need to
 * carry around a binary file just to hold the structure which will
 * be frequently needed.
 */

static const uint8_t LE_sigstruct[] = {
	0x06, 0x00, 0x00, 0x00, 0xe1, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x86, 0x80, 0x00, 0x00, 0x24, 0x07, 0x15, 0x20, \
	0x01, 0x01, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, \
	0x60, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, \
	0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x9f, 0x47, 0xde, 0xd1, 0xd7, 0xd9, 0x09, 0x1c, \
	0xd0, 0x76, 0x4d, 0xe5, 0xe2, 0x79, 0x8c, 0x20, \
	0xea, 0xc1, 0x03, 0x8f, 0x53, 0xa8, 0x66, 0x58, \
	0x1b, 0xcb, 0xc7, 0xc8, 0x4a, 0x45, 0x4b, 0x4d, \
	0x7b, 0x7b, 0x33, 0xb9, 0x9a, 0xa0, 0x2a, 0xc2, \
	0x43, 0xa8, 0xea, 0x3e, 0xe9, 0xca, 0x06, 0x5b, \
	0xe5, 0xdd, 0x46, 0xd8, 0x01, 0xba, 0x73, 0xd5, \
	0x44, 0xe4, 0x45, 0x53, 0xfa, 0xa3, 0xe8, 0x81, \
	0x51, 0x7a, 0x77, 0x18, 0x5c, 0x14, 0xca, 0x97, \
	0xf9, 0xb8, 0xe5, 0xc2, 0xbd, 0x4d, 0xdd, 0x38, \
	0x9b, 0xf3, 0xd7, 0xf8, 0xa9, 0x85, 0x6d, 0xf1, \
	0x00, 0xa5, 0x80, 0xad, 0x8f, 0x55, 0x76, 0x28, \
	0xfa, 0x5d, 0xfa, 0xe4, 0x31, 0xcb, 0x65, 0x5b, \
	0xbb, 0xd7, 0x86, 0xd4, 0xbd, 0x5d, 0xf5, 0xde, \
	0xaa, 0x23, 0xf5, 0xcd, 0xa2, 0x7a, 0x6c, 0xf0, \
	0x43, 0x57, 0xf5, 0x29, 0xfc, 0x27, 0xe7, 0x05, \
	0x25, 0xbb, 0x26, 0x81, 0xfc, 0xb6, 0xa9, 0xf6, \
	0xaf, 0xfd, 0x81, 0x86, 0x02, 0x85, 0x1a, 0x71, \
	0x71, 0x58, 0x87, 0xfd, 0xad, 0x52, 0x32, 0xd5, \
	0x6b, 0xfe, 0xb8, 0xdf, 0x09, 0x96, 0x04, 0xd0, \
	0x67, 0x57, 0xc2, 0xee, 0x03, 0x4b, 0x1c, 0x36, \
	0x47, 0x14, 0xca, 0x67, 0x61, 0x6d, 0x10, 0x75, \
	0x8b, 0x09, 0x2d, 0xd2, 0x18, 0x41, 0x4e, 0xa1, \
	0x3e, 0x4e, 0xe1, 0xaa, 0x06, 0x0b, 0x61, 0xee, \
	0x77, 0x48, 0xb0, 0x35, 0xeb, 0x96, 0xe9, 0x07, \
	0xfb, 0x52, 0xa6, 0x1a, 0x8c, 0x8c, 0x43, 0x43, \
	0x3b, 0xa7, 0xaf, 0x8c, 0xf3, 0x42, 0xb2, 0x1f, \
	0x26, 0x58, 0x8c, 0x0c, 0x72, 0xb8, 0xeb, 0x68, \
	0x31, 0xe8, 0xfb, 0xef, 0x24, 0xa3, 0x04, 0xe3, \
	0x1a, 0xb5, 0x2e, 0xa3, 0x7d, 0xfe, 0xbd, 0xdc, \
	0xec, 0x46, 0x44, 0xc8, 0x1a, 0x65, 0x98, 0x5c, \
	0xc3, 0x69, 0xc7, 0xe8, 0x58, 0xef, 0x29, 0x27, \
	0xed, 0x74, 0x18, 0x0d, 0x91, 0x89, 0x0a, 0x10, \
	0xdb, 0x8a, 0x0c, 0xab, 0x18, 0x42, 0xd8, 0x5e, \
	0x7f, 0xf7, 0xd1, 0x46, 0x2c, 0x1b, 0x8e, 0x1b, \
	0xa1, 0x7d, 0x93, 0x35, 0xc7, 0x6b, 0xe0, 0x73, \
	0xb4, 0x2b, 0x5b, 0x8c, 0x20, 0x2b, 0xfa, 0xce, \
	0x8d, 0x24, 0x9e, 0xd2, 0x88, 0x8e, 0x2d, 0xd8, \
	0x7f, 0x43, 0x65, 0xc7, 0xe6, 0x6f, 0x9f, 0xaa, \
	0xc7, 0xee, 0xbd, 0xf8, 0x76, 0x82, 0x00, 0xf3, \
	0x21, 0x0a, 0xf5, 0xa3, 0xbe, 0x77, 0xaf, 0xc7, \
	0x32, 0x56, 0x4f, 0x42, 0x0a, 0x78, 0x89, 0xf1, \
	0xd1, 0x94, 0x8c, 0x38, 0xec, 0x33, 0x72, 0x12, \
	0x42, 0xc9, 0x10, 0xe3, 0x1a, 0x64, 0x16, 0x67, \
	0x86, 0x1d, 0x58, 0xe4, 0x11, 0x85, 0xff, 0x0f, \
	0x4d, 0x8d, 0x58, 0x66, 0x7a, 0x2c, 0x76, 0x6e, \
	0x6d, 0x86, 0x07, 0xab, 0x97, 0x83, 0x5a, 0xff, \
	0xc3, 0xbf, 0x0a, 0xf4, 0xb6, 0xdb, 0x8a, 0xb7, \
	0x03, 0x00, 0x00, 0x00, 0x46, 0x7f, 0x80, 0x36, \
	0xb7, 0x62, 0xf2, 0x18, 0x2a, 0x6d, 0xa2, 0xb1, \
	0x93, 0x36, 0x41, 0x79, 0x41, 0xbd, 0x87, 0x82, \
	0xd4, 0x76, 0xa7, 0x04, 0x91, 0x2b, 0x6f, 0x1e, \
	0x0c, 0x7d, 0x96, 0x49, 0x2b, 0x14, 0xce, 0xd6, \
	0xb9, 0x5c, 0x33, 0x38, 0xf9, 0x8f, 0x99, 0xee, \
	0x26, 0xbb, 0x0b, 0xd9, 0x09, 0x7e, 0xb9, 0x89, \
	0xb0, 0x16, 0x02, 0x37, 0xd7, 0xd8, 0x45, 0xeb, \
	0x23, 0x42, 0x5b, 0x26, 0x0c, 0xb1, 0x21, 0x4f, \
	0x75, 0xd8, 0x85, 0xd6, 0xf0, 0x78, 0xee, 0x6a, \
	0x83, 0x70, 0x0a, 0x1f, 0x2c, 0x4b, 0xb2, 0x29, \
	0x58, 0x04, 0x78, 0xc4, 0x4b, 0x80, 0x8a, 0xae, \
	0x5f, 0x76, 0x8e, 0xa7, 0xda, 0xf7, 0xff, 0x85, \
	0x97, 0x28, 0x57, 0x2d, 0xdb, 0xc7, 0xc4, 0x34, \
	0xaa, 0x02, 0x74, 0x8b, 0x69, 0x1a, 0x29, 0xfb, \
	0xac, 0xe7, 0xd6, 0xc1, 0x35, 0x94, 0x96, 0x72, \
	0x43, 0x5c, 0x57, 0x05, 0x50, 0xe8, 0x61, 0x5c, \
	0x24, 0xfe, 0x4a, 0x81, 0x95, 0x54, 0x86, 0xb6, \
	0xd8, 0x6f, 0x9e, 0x55, 0xe7, 0xbc, 0xc4, 0x90, \
	0x68, 0x33, 0x89, 0xf0, 0x86, 0x25, 0xb8, 0x2a, \
	0x67, 0x84, 0x31, 0xc3, 0x57, 0x0e, 0xd4, 0xbc, \
	0xbb, 0x00, 0x85, 0x99, 0x4d, 0x6b, 0x30, 0x60, \
	0x4d, 0xc0, 0xc3, 0x00, 0x52, 0x53, 0xa8, 0x58, \
	0xdf, 0x10, 0x0c, 0x7d, 0x0f, 0x06, 0xa6, 0x2d, \
	0xa1, 0x27, 0xbb, 0xd6, 0xed, 0x3a, 0x1f, 0x75, \
	0xf3, 0x31, 0x46, 0x77, 0xae, 0x6c, 0x2b, 0x16, \
	0xc1, 0x75, 0xe9, 0xc3, 0x78, 0x4e, 0x23, 0xe4, \
	0xcc, 0x58, 0x6f, 0x93, 0xe2, 0x1b, 0xa9, 0x96, \
	0xd7, 0x6f, 0xe8, 0xd1, 0x7f, 0x15, 0x59, 0xe1, \
	0x2f, 0x29, 0x0f, 0xb1, 0xe9, 0xd9, 0x94, 0x2e, \
	0xf5, 0xee, 0xd7, 0x84, 0xcb, 0xbd, 0x27, 0x75, \
	0xfa, 0xad, 0xde, 0xf7, 0xe5, 0xe9, 0xbb, 0x64, \
	0x59, 0x4d, 0x72, 0x04, 0xc0, 0x26, 0x02, 0x25, \
	0x93, 0x31, 0xaa, 0xac, 0x88, 0x6f, 0x48, 0xd4, \
	0x80, 0x99, 0xfd, 0x19, 0x41, 0x16, 0xfa, 0xc4, \
	0xfb, 0xf6, 0x2b, 0x42, 0xbc, 0x9c, 0xd6, 0x25, \
	0x01, 0x38, 0x3e, 0xf9, 0xe6, 0x9f, 0x0d, 0x30, \
	0xf4, 0xd1, 0x73, 0x70, 0xbf, 0x8c, 0x47, 0xfb, \
	0x4e, 0xcd, 0xa0, 0x76, 0x0e, 0xdd, 0xce, 0xd9, \
	0xd5, 0xdb, 0x83, 0x60, 0x42, 0x94, 0x84, 0x61, \
	0xdc, 0xff, 0x1f, 0xd5, 0x03, 0xef, 0x14, 0xf8, \
	0x7d, 0xb6, 0xb6, 0x29, 0x20, 0x38, 0xf3, 0x16, \
	0x75, 0xe9, 0xe6, 0x71, 0x1e, 0x85, 0x6f, 0x60, \
	0xc2, 0x67, 0xc6, 0x1a, 0x1c, 0xa5, 0x68, 0x58, \
	0xb6, 0xe7, 0xcd, 0x81, 0x62, 0x98, 0x76, 0x81, \
	0xa9, 0xbf, 0x73, 0xfc, 0x2f, 0x48, 0xed, 0xb3, \
	0x04, 0xcf, 0x4f, 0xcf, 0xa4, 0x69, 0x3c, 0x0d, \
	0x3b, 0xd5, 0x24, 0x34, 0x34, 0x54, 0xf3, 0x21, \
	0xb3, 0xd9, 0x1b, 0x56, 0x00, 0x00, 0x00, 0x00, \
	0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, \
	0x1b, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, \
	0x3f, 0xb6, 0x23, 0x82, 0x06, 0xb1, 0x9c, 0x8e, \
	0x3b, 0x24, 0xde, 0xd8, 0xca, 0xcc, 0x9d, 0xd9, \
	0x42, 0x83, 0x72, 0x89, 0x8e, 0x34, 0xcd, 0x2d, \
	0xa4, 0xa5, 0x16, 0x6e, 0xcf, 0xb1, 0x6f, 0x74, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x20, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	0x27, 0xee, 0xd5, 0xc2, 0xfe, 0x56, 0x09, 0x37, \
	0xa0, 0x97, 0x7b, 0x9c, 0x60, 0x4a, 0xf2, 0x27, \
	0xc7, 0x13, 0x6e, 0xa6, 0x87, 0x46, 0xa6, 0x09, \
	0x2a, 0x90, 0x53, 0xce, 0x9d, 0x4c, 0x1b, 0xce, \
	0x1a, 0xf3, 0xe1, 0x1d, 0xa6, 0x14, 0x63, 0x10, \
	0x4b, 0xf6, 0xaa, 0x10, 0x6d, 0x00, 0xdd, 0x1b, \
	0xe3, 0xfa, 0x9d, 0x48, 0x2e, 0x39, 0x76, 0x83, \
	0xf7, 0x92, 0x13, 0xb6, 0x7e, 0xbf, 0xf5, 0x91, \
	0xdb, 0x45, 0xb5, 0x76, 0xfd, 0x76, 0xfc, 0x41, \
	0xca, 0x3e, 0x66, 0x04, 0x33, 0xca, 0xe1, 0x9e, \
	0x8e, 0x6f, 0x05, 0x09, 0x30, 0x14, 0x39, 0xda, \
	0xf3, 0x4c, 0xd9, 0x84, 0x86, 0xbd, 0x79, 0x8b, \
	0x4a, 0x06, 0x46, 0x9a, 0xe7, 0x57, 0x5c, 0xa7, \
	0x78, 0xd6, 0x62, 0x34, 0xa7, 0x3b, 0x22, 0x07, \
	0xeb, 0x51, 0x8a, 0x2f, 0xd5, 0x4a, 0x87, 0x59, \
	0x3a, 0xe8, 0x25, 0xa2, 0x50, 0x5b, 0x1b, 0xf2, \
	0xc7, 0x12, 0xcb, 0xee, 0xf7, 0x6f, 0x04, 0xa4, \
	0x66, 0xd9, 0x90, 0x51, 0xb6, 0x45, 0x33, 0xc8, \
	0x92, 0x06, 0x41, 0xb6, 0x27, 0x54, 0x8c, 0x34, \
	0x6d, 0xf5, 0x36, 0x3f, 0xa3, 0x00, 0x4b, 0xb5, \
	0xf2, 0xb9, 0x14, 0xe5, 0xa7, 0x29, 0x16, 0x2b, \
	0x4a, 0x8b, 0xfa, 0x03, 0x0f, 0x8a, 0xa2, 0xe0, \
	0x29, 0x11, 0x3d, 0x0a, 0xbf, 0xe4, 0x29, 0x3b, \
	0xdf, 0x88, 0xd1, 0x7e, 0x03, 0xbe, 0x80, 0x34, \
	0x7c, 0x1d, 0xbf, 0x7f, 0x0f, 0x4a, 0xee, 0x6e, \
	0xa4, 0x9b, 0x8d, 0x2d, 0xc8, 0xc3, 0x7b, 0xcc, \
	0x79, 0xfc, 0xb7, 0x16, 0x0a, 0x83, 0xc2, 0xbb, \
	0x0d, 0x5d, 0xf3, 0xcf, 0x58, 0x04, 0xd3, 0xcb, \
	0x60, 0xec, 0x06, 0xa5, 0x22, 0xf8, 0xe5, 0xd3, \
	0x7c, 0x22, 0x4a, 0xe5, 0x55, 0x03, 0xff, 0xce, \
	0xfb, 0xd6, 0x83, 0x08, 0x2b, 0xef, 0x07, 0x09, \
	0xc2, 0xd5, 0xd8, 0x8e, 0xe3, 0x04, 0xba, 0x38, \
	0x6e, 0x5e, 0x96, 0x0b, 0xff, 0x25, 0x06, 0xfb, \
	0x8b, 0x66, 0x22, 0xe9, 0x51, 0x52, 0x23, 0xd8, \
	0x67, 0x6c, 0xf5, 0xf5, 0x86, 0x9a, 0xda, 0x67, \
	0xd4, 0xf5, 0x5c, 0x02, 0xd4, 0x05, 0xa7, 0x17, \
	0xc4, 0x0f, 0x9d, 0xf3, 0xf4, 0x7a, 0x4c, 0x7e, \
	0x24, 0x1f, 0x13, 0xff, 0x4c, 0x65, 0xc2, 0x3e, \
	0xac, 0x29, 0xa8, 0x7b, 0x16, 0x27, 0xe3, 0x15, \
	0xac, 0x88, 0x3d, 0xab, 0xca, 0x75, 0x32, 0xfc, \
	0x28, 0xee, 0xe0, 0x77, 0x5c, 0xaf, 0x7f, 0xca, \
	0x3f, 0x6b, 0x88, 0x86, 0xbf, 0xda, 0xd5, 0x1e, \
	0xdc, 0x56, 0xf1, 0x3b, 0x43, 0xfd, 0xe6, 0x7e, \
	0xb6, 0xc8, 0x26, 0x16, 0x09, 0x40, 0xc2, 0x32, \
	0x6b, 0xf0, 0xa9, 0x3b, 0x6d, 0xa2, 0xd7, 0x93, \
	0x94, 0x7e, 0x9a, 0x8c, 0x29, 0x32, 0xf2, 0x2c, \
	0x05, 0xe4, 0x44, 0xbe, 0x1e, 0x30, 0x65, 0x99, \
	0x11, 0x7b, 0xfa, 0xe3, 0x3b, 0xdb, 0x65, 0x28, \
	0x93, 0x97, 0x2d, 0x57, 0x83, 0x61, 0x98, 0x44, \
	0x59, 0x5e, 0xbd, 0x59, 0x81, 0xe2, 0xc1, 0xf9, \
	0xd8, 0x4d, 0x80, 0x01, 0x22, 0x41, 0xde, 0x1b, \
	0x67, 0x1d, 0x56, 0x77, 0x13, 0x71, 0xc9, 0xfd, \
	0x07, 0xfc, 0x17, 0x66, 0xd4, 0x1a, 0x71, 0xa7, \
	0x42, 0x7d, 0xbd, 0x79, 0xf5, 0x2a, 0xf2, 0xaa, \
	0xcb, 0x47, 0x7b, 0xec, 0xf7, 0x2a, 0x6a, 0x3b, \
	0x9d, 0x2c, 0x74, 0x43, 0x7d, 0xe4, 0x6a, 0x7c, \
	0x0c, 0x0d, 0x78, 0x55, 0x35, 0x67, 0xeb, 0x4d, \
	0x23, 0xb3, 0x9e, 0xb1, 0xcb, 0xcf, 0xdc, 0xcc, \
	0xc6, 0x43, 0x53, 0xba, 0x9f, 0x8c, 0xbb, 0xc0, \
	0xe6, 0xb6, 0x50, 0x01, 0x85, 0xc6, 0x1e, 0x17, \
	0x42, 0xe8, 0x40, 0x22, 0x00, 0xd4, 0xd7, 0xd9, \
	0xb8, 0x82, 0xb5, 0xb6, 0x82, 0x22, 0xc0, 0xa4, \
	0xd5, 0xc5, 0x28, 0x35, 0x92, 0x02, 0xfe, 0xd3, \
	0x44, 0xf3, 0xd3, 0xf4, 0x31, 0x1d, 0x8a, 0x35, \
	0x8e, 0x8f, 0xaf, 0x5d, 0x2c, 0x04, 0x07, 0x07, \
	0x25, 0xc5, 0x52, 0x5c, 0x91, 0x8a, 0x3f, 0xb1, \
	0x9e, 0x78, 0x7f, 0xb6, 0xaf, 0x81, 0x25, 0xc4, \
	0x26, 0x81, 0xd6, 0xcd, 0x3b, 0xe5, 0xc3, 0x36, \
	0x49, 0x21, 0xdd, 0x91, 0x77, 0x77, 0xaa, 0x03, \
	0xa2, 0x14, 0x18, 0xe0, 0xea, 0x93, 0x32, 0xf3, \
	0xfc, 0xf5, 0xd3, 0xb7, 0xd7, 0x20, 0x43, 0x38, \
	0x7d, 0x4c, 0xd2, 0x53, 0xe9, 0x3e, 0xc1, 0x15, \
	0x22, 0xee, 0x4f, 0x73, 0xdc, 0xbf, 0xe6, 0xe6, \
	0x25, 0xd5, 0x26, 0x36, 0xb9, 0xce, 0x57, 0x7a, \
	0x72, 0xc0, 0xd2, 0x56, 0x5c, 0x70, 0xb2, 0x13, \
	0xd2, 0x12, 0x5a, 0xa9, 0x91, 0x79, 0x59, 0x2f, \
	0x9e, 0x79, 0xe4, 0x8e, 0x66, 0xd4, 0xf7, 0x31, \
	0xff, 0x46, 0x73, 0x4a, 0xd4, 0x3c, 0x82, 0xd5, \
	0x79, 0x7d, 0x5b, 0xb9, 0x2f, 0xd1, 0xe1, 0x8d, \
	0xe1, 0xa1, 0xb5, 0xfd, 0x56, 0x80, 0xb4, 0x6f, \
	0xe4, 0x33, 0x57, 0x11, 0xc0, 0x6b, 0x88, 0xa2, \
	0x44, 0xcb, 0x3d, 0xc1, 0xfb, 0x40, 0x68, 0x72, \
	0x04, 0x87, 0x18, 0xe2, 0xe2, 0x99, 0x87, 0x66, \
	0xd3, 0x68, 0xbe, 0x0a, 0x5b, 0xa4, 0xb1, 0xfa, \
	0xd5, 0x53, 0x10, 0xfa, 0xd6, 0x79, 0x89, 0xfb, \
	0x43, 0xad, 0x56, 0x80, 0xee, 0x6b, 0x3e, 0xc3, \
	0xab, 0x9f, 0x9f, 0x36, 0xce, 0xf5, 0x68, 0x72, \
	0xff, 0x47, 0x50, 0x95, 0x4d, 0x3a, 0x16, 0x8d, \
	0xc5, 0x3d, 0x86, 0x0c, 0xf8, 0xe1, 0x30, 0x2a, \
	0x7b, 0xec, 0xb8, 0x2c, 0x94, 0xec, 0x5a, 0x80, \
	0xa7, 0x3c, 0x27, 0x98, 0xa2, 0x18, 0xe3, 0x08, \
	0x2a, 0x3e, 0xa5, 0x4d, 0x58, 0xf3, 0x81, 0x45, \
	0x53, 0x68, 0xd9, 0xdb, 0x83, 0x45, 0x20, 0x02, \
	0xc3, 0xb0, 0xcc, 0x2d, 0x43, 0x44, 0xd4, 0x50, \
	0x4f, 0xf5, 0x63, 0xa9, 0x32, 0xac, 0x1c, 0x54, \
	0xd4, 0x68, 0xbc, 0x2b, 0x65, 0x6c, 0x48, 0x4a  \
};


/** SGXsigstruct private state information. */
struct NAAAIM_SGXsigstruct_State
{
	/* The root object. */
	Origin root;

	/* Library identifier. */
	uint32_t libid;

	/* Object identifier. */
	uint32_t objid;

	/* Object status. */
	_Bool poisoned;

	/* The SGX signature structure. */
	struct SGX_sigstruct sigstruct;
};


/**
 * Internal private method.
 *
 * This method is responsible for initializing the NAAAIM_SGXsigstruct_State
 * structure which holds state information for each instantiated object.
 *
 * \param S	A pointer to the object containing the state information which
 *		is to be initialized.
 */

static void _init_state(CO(SGXsigstruct_State, S)) {

	S->libid = NAAAIM_LIBID;
	S->objid = NAAAIM_SGXsigstruct_OBJID;

	S->poisoned = false;

	memset(&S->sigstruct, '\0', sizeof(struct SGX_sigstruct));

	return;
}


/**
 * External public method.
 *
 * This method implements the loading of a SIGSTRUCT from an external
 * file.  It is currently implemented to support the fact that Intel
 * supplies data data for a SIGSTRUCT in binary form which is needed
 * to initialize the launch enclave (LE).
 *
 * \param this		A pointer to the object which is to hold the
 *			signature structure.
 *
 * \param fname		A pointer to the null-terminated character
 *			buffer which holds the name of the file
 *			containing a SIGSTRUCT in packed binary
 *			form.
 *
 * \return	If an error is encountered while loading the signature
 *		structure a false value is returned.  A true value is
 *		returned if the object contains valid signature
 *		structure.
 */

static _Bool load(CO(SGXsigstruct, this), CO(char *, fname))

{
	STATE(S);

	_Bool retn = false;

	Buffer bufr = NULL;

	File file = NULL;


	INIT(HurdLib, Buffer, bufr, ERR(goto done));
	INIT(HurdLib, File, file, ERR(goto done));


	file->open_ro(file, fname);
	if ( !file->slurp(file, bufr) )
		ERR(goto done);

	if ( bufr->size(bufr) != sizeof(struct SGX_sigstruct) )
		ERR(goto done);
	S->sigstruct = *(struct SGX_sigstruct *) bufr->get(bufr);

	retn = true;


 done:
	if ( !retn )
		S->poisoned = true;
		
	WHACK(bufr);
	WHACK(file);

	return retn;
}


/**
 * External public method.
 *
 * This method implements an accessor method which populates a user
 * supplied signature structure with the value represented by the
 * object.
 *
 * \param this		A pointer to the object which holds the signature
 *			structure to be returned.
 *
 * \param sigstruct	A pointer to the structure which is to be
 *			populated.
 *
 * \return	If an error is encountered while loading the structure
 *		a false value is returned.  A true value is returned
 *		if the supplied structure posesses a valid copy of
 *		the structure.
 */

static _Bool get(CO(SGXsigstruct, this), struct SGX_sigstruct *sigstruct)

{
	STATE(S);

	_Bool retn = false;


	/* Verify status of object. */
	if ( S->poisoned )
		ERR(goto done);

	*sigstruct = S->sigstruct;
	retn = true;


 done:
	if ( !retn )
		S->poisoned = true;

	return retn;
}


/**
 * External public method.
 *
 * This method implements an accessor method which populates a user
 * supplied signature structure with the default launch enclave which
 * was encoded into this file at the time of its build.
 *
 * \param this		A pointer to the object which holds the launch
 *			enclave signature structure to be returned.
 *
 * \param sigstruct	A pointer to the structure which is to be
 *			populated.
 *
 * \return	If an error is encountered while loading the structure
 *		a false value is returned.  A true value is returned
 *		if the supplied structure posesses a valid copy of
 *		the structure.
 */

static _Bool get_LE(CO(SGXsigstruct, this), struct SGX_sigstruct *sigstruct)

{
	STATE(S);

	_Bool retn = false;

	struct SGX_sigstruct *sp = (struct SGX_sigstruct *) LE_sigstruct;


	/* Verify status of object. */
	if ( S->poisoned )
		ERR(goto done);

	*sigstruct = *sp;
	retn = true;

 done:
	if ( !retn )
		S->poisoned = true;

	return retn;
}


/**
 * External public method.
 *
 * This method implements the generation of the conversion of a binary
 * SIGSTRUCT structure into a C based character array.  This is used
 * to automate conversion of a structure which is supplied in binary
 * to one which can be embedded in a program to avoid the need to
 * carry an additional file and then conduct I/O against it.
 *
 * \param this	A pointer to the object which holds the signature
 *		to be converted.
 *
 * \return	If an error is encountered while generating the output
 *		a false value is returned.  A true value indicates a
 *		valid structure was presented on the output.
 */

static _Bool generate(CO(SGXsigstruct, this))

{
	STATE(S);

	_Bool retn = false;

	uint8_t *sp;

	uint16_t lp;


	/* Verify status of object and . */
	if ( S->poisoned )
		ERR(goto done);
	if ( sizeof(S->sigstruct) > (1 << 16) )
		ERR(goto done);


	fputs("static const uint8_t LE_sigstruct[] = {\n\t", stdout);

	sp = (uint8_t *) &S->sigstruct;
	for (lp= 1; lp <= sizeof(struct SGX_sigstruct); ++lp) {
		fprintf(stdout, "0xx%02x", sp[lp-1]);
		if ( (lp % 8) == 0 ) {
			if ( lp == sizeof(struct SGX_sigstruct) )
				fputs("  \\\n", stdout);
			else
				fputs(", \\\n\t", stdout);
		}
		else
			fputs(", ", stdout);
	}
	fputs("};\n", stdout);

	retn = true;


 done:
	if ( !retn )
		S->poisoned = true;

	return retn;
}


/**
 * Internal private function
 *
 * This function implements printing out of a character buffer.  It is
 * a utility function to simplify output for the ->dump method.
 *
 * \param bufr		A pointer to the buffer to be dumped.
 *
 * \param cnt		The length of the buffer in bytes.
 *
 * \return		No return value is defined.
 */

static void _print_buffer(CO(char *, prefix), CO(uint8_t *, bufr), size_t cnt)

{
	size_t lp;


	fputs(prefix, stdout);
	for (lp= 0; lp < cnt; ++lp) {
		fprintf(stdout, "%02x ", bufr[lp]);
		if ( (lp+1 < cnt) && ((lp+1) % 16) == 0 )
			fputs("\n\t", stdout);
	}
	fputc('\n', stdout);

	return;
}


/**
 * External public method.
 *
 * This method implements dumping the contents of a SIGSTRUCT in
 * readable form for diagnostic purposes.
 *
 * \param this	A pointer to the object which holds the signature
 *		structure to be dumped.
 *
 * \return	No return value is defined.
 */

static void dump(CO(SGXsigstruct, this))

{
	STATE(S);

	struct SGX_sigstruct *sp = &S->sigstruct;


	fputs("\nSIGSTRUCT:\n", stdout);
	fputs("header: ", stdout);
	_print_buffer("", sp->header, sizeof(sp->header));

	fprintf(stdout, "vendor: 0x%x\n", sp->vendor);
	fprintf(stdout, "date: %x\n", sp->date);
	fprintf(stdout, "hw version: 0x%x\n", sp->sw_defined);
	fprintf(stdout, "exponent: 0x%x\n", sp->exponent);

	fputs("modulus:\n", stdout);
	_print_buffer("\t", sp->modulus, sizeof(sp->modulus));

	fputs("signature:\n", stdout);
	_print_buffer("\t", sp->signature, sizeof(sp->signature));

	fprintf(stdout, "misc select: 0x%0x\n", sp->miscselect);
	fprintf(stdout, "misc mask: 0x%0x\n", sp->miscmask);

	fputs("attributes:\n", stdout);
	fprintf(stdout, "\tFlags: 0x%0lx\n", sp->attributes.flags);
	fprintf(stdout, "\tXFRM: 0x%0lx\n", sp->attributes.xfrm);

	fputs("attribute mask:\n", stdout);
	fprintf(stdout, "\tFlags: 0x%0lx\n", sp->attribute_mask.flags);
	fprintf(stdout, "\tXFRM: 0x%0lx\n", sp->attribute_mask.xfrm);

	fputs("enclave measurement:\n", stdout);
	_print_buffer("\t", sp->enclave_hash, sizeof(sp->enclave_hash));

	fprintf(stdout, "isv prodid: 0x%0x\n", sp->isv_prodid);
	fprintf(stdout, "isv svn: 0x%0x\n", sp->isv_svn);

	fputs("key q1:\n", stdout);
	_print_buffer("\t", sp->q1, sizeof(sp->q1));

	fputs("key q2:\n", stdout);
	_print_buffer("\t", sp->q2, sizeof(sp->q2));

	return;
}


/**
 * External public method.
 *
 * This method implements a destructor for a SGXsigstruct object.
 *
 * \param this	A pointer to the object which is to be destroyed.
 */

static void whack(CO(SGXsigstruct, this))

{
	STATE(S);

	S->root->whack(S->root, this, S);
	return;
}


/**
 * External constructor call.
 *
 * This function implements a constructor call for a SGXsigstruct object.
 *
 * \return	A pointer to the initialized SGXsigstruct.  A null value
 *		indicates an error was encountered in object generation.
 */

extern SGXsigstruct NAAAIM_SGXsigstruct_Init(void)

{
	auto Origin root;

	auto SGXsigstruct this = NULL;

	auto struct HurdLib_Origin_Retn retn;


	/* Get the root object. */
	root = HurdLib_Origin_Init();

	/* Allocate the object and internal state. */
	retn.object_size  = sizeof(struct NAAAIM_SGXsigstruct);
	retn.state_size   = sizeof(struct NAAAIM_SGXsigstruct_State);
	if ( !root->init(root, NAAAIM_LIBID, NAAAIM_SGXsigstruct_OBJID, \
			 &retn) )
		return NULL;
	this	    	  = retn.object;
	this->state 	  = retn.state;
	this->state->root = root;

	/* Initialize aggregate objects. */

	/* Initialize object state. */
	_init_state(this->state);

	/* Method initialization. */
	this->load = load;

	this->get    = get;
	this->get_LE = get_LE;

	this->generate = generate;
	this->dump     = dump;
	this->whack    = whack;

	return this;
}
